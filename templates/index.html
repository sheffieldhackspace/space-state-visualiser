<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
      crossorigin="anonymous"
    ></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background-color: black;
        z-index: -1001;
        position: relative;
      }
      #state {
        position: relative;
        height: 100%;
        width: 100%;
        max-height: 100vh;
      }
      #state img {
        position: absolute;
        inset: 0;
        height: auto;
        width: auto;
        max-width: 100%;
        max-height: 100%;
        margin: auto;
        width: 100%;
      }
      #space {
        z-index: -1000;
      }
      #clock {
        position: absolute;
        margin: 2rem 7rem;
        top: 0;
        right: 1rem;
        color: white;
        font-size: 4rem;
        font-family: "Courier New", Courier, monospace;
      }
      #statebuttons {
        position: absolute;
        bottom: 0;
        left: 0;
        display: flex;
        gap: 1rem;
        margin: 1rem;
      }
      #statebuttons a,
      #statebuttons a:visited {
        color: black;
        background-color: white;
        border-radius: 1rem;
        padding: 1rem;
        text-decoration: none;
      }
      #statebuttons a.active {
        background-color: darkgreen;
      }
    </style>
  </head>
  <body>
    <p id="clock"></p>
    <div id="state">
      <img id="space" src="/static/icons/space.jpg" />
      {% for listener in listeners %}
      <img
        id="{{ listener.id }}"
        src="/static/icons/{{ listener.id }}.{% if view_state %}{{ view_state }}{% else %}{% if listener.lastState %}{{ listener.lastState }}{% else %}NA{% endif %}{% endif %}.png"
        {%if
        listener.z
        %}style="z-index: {{ listener.z }}"
        {%
        endif
        %}
      />
      {% endfor %}
    </div>
    {% if view_state %}
    <div id="statebuttons">
      <a href="?state=NA" class="{% if view_state == 'NA' %}active{% endif %}">
        NA
      </a>
      <a href="?state=on" class="{% if view_state == 'on' %}active{% endif %}">
        on
      </a>
      <a
        href="?state=off"
        class="{% if view_state == 'off' %}active{% endif %}"
      >
        off
      </a>
    </div>
    {% endif %}
    <script type="text/javascript" charset="utf-8">
      {% if do_socket %}
      // update image with ID with state (NA, on, or off)
      function update_image(listener, state) {
        const id = listener["id"];
        const url = "/static/icons/" + id + "." + state + ".png";

        console.groupCollapsed(`update <${id}> to <${state}>`);
        console.log(listener);
        console.log("url: " + window.location + url);
        console.groupEnd();

        const image = document.getElementById(id);
        image.setAttribute("src", url);
      }

      const socket = io();
      socket.on("connect", function () {
        // socket.emit("my event", { data: "I'm connected!" });
      });
      socket.on("status-update", function (data) {
        const listener = data[0];
        const new_state = data[1];
        update_image(listener, new_state);
      });

      // fetch("/listeners.json")
      //   .then((data) => data.json())
      //   .catch(() => console.log("failed to load listeners"))
      //   .then((json) => {
      //     listeners = json;
      //     console.log("got listeners, ", json);
      //     listeners.forEach((listener) => {
      //       update_image(listener, listener["lastState"] ?? "NA");
      //     });
      //   });
      {% endif %}
    </script>
    <script>
      // clock
      const clock = document.getElementById("clock");
      let interval = setInterval(function () {
        clock.textContent = new Date().toLocaleTimeString("en-GB");
      }, 1000);

    </script>
  </body>
</html>
